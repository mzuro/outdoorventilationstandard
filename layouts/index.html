{{- define "main" }}

<style>
/* ===== HOMEPAGE CUSTOM STYLES ===== */
/* Uses PaperMod CSS variables for theme consistency */

.home-hero {
  text-align: center;
  padding: 40px 0 24px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 16px;
}
.home-hero h1 {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 6px;
  letter-spacing: -0.5px;
}
.home-hero .last-updated {
  font-size: 0.78rem;
  color: var(--secondary);
  margin-bottom: 16px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.home-hero .tagline {
  font-size: 1.05rem;
  color: var(--secondary);
  max-width: 680px;
  margin: 0 auto 20px;
  line-height: 1.65;
}
.home-hero .hero-benefits {
  max-width: 600px;
  margin: 20px auto 0;
  text-align: left;
}
.home-hero .benefit {
  font-size: 0.95rem;
  color: var(--secondary);
  line-height: 1.65;
  margin-bottom: 12px;
}
.home-hero .benefit strong {
  color: var(--primary);
}

/* Mission section */
.home-mission {
  max-width: 780px;
  margin: 0 auto 36px;
}
.home-mission h2 {
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--primary);
  margin-bottom: 12px;
}
.home-mission p {
  color: var(--content);
  line-height: 1.7;
  margin-bottom: 12px;
}
.home-mission .approach-list {
  list-style: none;
  padding: 0;
  margin: 16px 0;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 24px;
}
.home-mission .approach-list li {
  color: var(--content);
  font-size: 0.9rem;
  padding-left: 20px;
  position: relative;
}
.home-mission .approach-list li::before {
  content: "";
  position: absolute;
  left: 0;
  top: 8px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--tertiary);
}

/* Diagram showcase */
.home-diagram {
  margin: 36px 0;
  background: var(--entry);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.home-diagram img {
  width: 100%;
  height: auto;
  display: block;
}
.home-diagram .diagram-caption {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  font-size: 0.8rem;
  color: var(--secondary);
}
.home-diagram .diagram-caption a {
  color: var(--primary);
  text-decoration: none;
  box-shadow: 0 1px 0 var(--primary);
}
.home-diagram .diagram-caption a:hover {
  box-shadow: none;
}

/* Feature cards */
.home-features {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin: 36px 0;
}
.feature-card {
  background: var(--entry);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 24px 20px;
  text-decoration: none;
  transition: border-color 0.2s ease;
  display: flex;
  flex-direction: column;
}
.feature-card:hover {
  border-color: var(--primary);
}
.feature-card .card-icon {
  font-size: 1.6rem;
  margin-bottom: 12px;
  line-height: 1;
}
.feature-card h3 {
  font-size: 1rem;
  font-weight: 600;
  color: var(--primary);
  margin-bottom: 8px;
}
.feature-card p {
  font-size: 0.85rem;
  color: var(--secondary);
  line-height: 1.55;
  flex: 1;
}
.feature-card .card-link {
  font-size: 0.8rem;
  color: var(--primary);
  margin-top: 12px;
  font-weight: 500;
}

/* Research highlights */
.home-section {
  margin: 40px 0;
}
.home-section h2 {
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--primary);
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}
.research-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.research-item {
  display: flex;
  gap: 12px;
  padding: 12px 14px;
  background: var(--entry);
  border: 1px solid var(--border);
  border-radius: 6px;
  text-decoration: none;
  transition: border-color 0.2s ease;
  align-items: flex-start;
}
.research-item:hover {
  border-color: var(--primary);
}
.research-item .ri-id {
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--secondary);
  background: var(--tertiary);
  padding: 2px 6px;
  border-radius: 3px;
  white-space: nowrap;
  flex-shrink: 0;
  margin-top: 2px;
}
.research-item .ri-title {
  font-size: 0.85rem;
  color: var(--primary);
  line-height: 1.4;
}
.research-item .ri-tier {
  font-size: 0.7rem;
  color: var(--secondary);
  margin-top: 2px;
}

/* CTA bottom */
.home-cta {
  text-align: center;
  padding: 32px 0;
  border-top: 1px solid var(--border);
  margin-top: 40px;
}
.home-cta p {
  color: var(--secondary);
  font-size: 0.9rem;
  margin-bottom: 16px;
}
.home-cta .cta-buttons {
  display: flex;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
}
.cta-btn {
  display: inline-block;
  padding: 10px 24px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 500;
  text-decoration: none;
  transition: opacity 0.2s ease;
}
.cta-btn:hover {
  opacity: 0.85;
}
.cta-primary {
  background: var(--primary);
  color: var(--theme);
}
.cta-secondary {
  background: var(--tertiary);
  color: var(--primary);
}

/* Question picker */
.home-questions {
  max-width: 680px;
  margin: 0 auto 32px;
  text-align: center;
}
.home-questions h2 {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--primary);
  margin-bottom: 10px;
}
/* iOS segmented control — matches search page */
.search-modes {
  display: inline-flex;
  margin-bottom: 14px;
  background: var(--border);
  border-radius: 17px;
  padding: 2px;
}
.search-mode-btn {
  padding: 4px 14px;
  font-size: 0.7rem;
  font-weight: 500;
  font-family: inherit;
  cursor: pointer;
  border: none;
  border-radius: 15px;
  background: transparent;
  color: var(--secondary);
  transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
  line-height: 1.4;
}
.search-mode-btn.active {
  background: var(--theme);
  color: var(--primary);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
}
.search-mode-btn:not(.active):hover {
  color: var(--primary);
}
.q-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-bottom: 16px;
}
.q-chip {
  background: var(--entry);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 0.85rem;
  color: var(--primary);
  cursor: pointer;
  transition: border-color 0.2s ease, background 0.2s ease;
  font-family: inherit;
}
.q-chip:hover {
  border-color: var(--primary);
}
.q-chip.active {
  background: var(--primary);
  color: var(--theme);
  border-color: var(--primary);
}
.q-input-wrap {
  display: flex;
  gap: 8px;
  max-width: 480px;
  margin: 0 auto;
}
.q-input {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 0.85rem;
  color: var(--primary);
  background: var(--theme);
  font-family: inherit;
}
.q-input:focus {
  border-color: var(--primary);
  outline: none;
}
.q-submit {
  padding: 10px 20px;
  background: var(--primary);
  color: var(--theme);
  border: none;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  font-family: inherit;
  transition: opacity 0.2s ease;
}
.q-submit:hover {
  opacity: 0.85;
}
.q-answer {
  max-width: 560px;
  margin: 20px auto 16px;
  text-align: left;
  background: var(--entry);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 20px;
  display: none;
  animation: fadeSlideIn 0.3s ease;
}
.q-answer.visible {
  display: block;
}
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(-8px); }
  to { opacity: 1; transform: translateY(0); }
}
.q-answer-text {
  font-size: 0.9rem;
  color: var(--content);
  line-height: 1.65;
  margin-bottom: 14px;
}
.q-answer-label {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
  margin-top: 0;
}
.q-answer-links {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.q-answer-links a {
  display: block;
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--primary);
  text-decoration: none;
  padding: 8px 14px;
  background: var(--theme);
  border: 1px solid var(--border);
  border-radius: 6px;
  transition: border-color 0.2s ease, background 0.15s ease;
}
.q-answer-links a:hover {
  border-color: var(--primary);
  background: var(--entry);
}

/* AI loading state */
.q-answer-loading {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.9rem;
  color: var(--secondary);
}
.q-answer-loading .spinner {
  width: 18px;
  height: 18px;
  border: 2px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  flex-shrink: 0;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.q-submit:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.q-answer-source {
  font-size: 0.7rem;
  color: var(--secondary);
  margin-top: 10px;
  margin-bottom: 0;
  opacity: 0.6;
}
/* Honeypot — invisible to humans, bots fill it */
.q-honey {
  position: absolute;
  left: -9999px;
  width: 1px;
  height: 1px;
  overflow: hidden;
  opacity: 0;
}
/* Question history */
.q-history {
  max-width: 480px;
  margin: 12px auto 0;
}
.q-history-label {
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
  opacity: 0.6;
}
.q-history-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.q-history-item {
  background: var(--entry);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 4px 12px;
  font-size: 0.75rem;
  color: var(--secondary);
  cursor: pointer;
  font-family: inherit;
  transition: border-color 0.2s ease;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.q-history-item:hover {
  border-color: var(--primary);
  color: var(--primary);
}
/* Ask another prompt */
.q-ask-another {
  display: inline-block;
  margin-top: 12px;
  font-size: 0.8rem;
  font-weight: 500;
  color: var(--primary);
  cursor: pointer;
  background: none;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 16px;
  font-family: inherit;
  transition: border-color 0.2s ease;
}
.q-ask-another:hover {
  border-color: var(--primary);
}

/* Responsive */
@media (max-width: 768px) {
  .home-hero {
    padding: 1.5em 0 12px;
    margin-bottom: 6px;
  }
  .home-hero h1 {
    font-size: 1.4rem;
    margin-top: 0;
    margin-bottom: 2px;
  }
  .home-hero .last-updated {
    margin-bottom: 8px;
  }
  .home-hero .tagline {
    font-size: 0.88rem;
    line-height: 1.55;
    margin-bottom: 10px;
  }
  .home-hero .hero-benefits {
    margin: 8px auto 0;
  }
  .home-hero .benefit {
    font-size: 0.85rem;
    margin-bottom: 6px;
    line-height: 1.55;
  }
  .hero-cta {
    margin-top: 12px !important;
  }
  .hero-cta .cta-btn {
    padding: 8px 14px;
    font-size: 0.75rem;
  }
  .home-questions {
    margin-top: 6px;
    margin-bottom: 20px;
  }
  .home-questions h2 {
    font-size: 1.1rem;
    margin-bottom: 10px;
  }
  .home-features {
    grid-template-columns: 1fr;
  }
  .research-grid {
    grid-template-columns: 1fr;
  }
  .home-mission .approach-list {
    grid-template-columns: 1fr;
  }
  .q-chips {
    gap: 6px;
  }
  .q-chip {
    font-size: 0.78rem;
    padding: 6px 12px;
  }
  .q-answer {
    padding: 16px;
  }
}
</style>

<!-- ===== HERO ===== -->
<section class="home-hero">
  <h1>Outdoor Ventilation Standard</h1>
  <p class="last-updated">Last Updated: February 2026</p>
  <p class="tagline">
    Independently researched, physics-grounded analysis of outdoor cooking ventilation.
    No existing standard addresses hood systems in open-air environments &mdash; this research program fills that gap.
  </p>
  <div class="hero-benefits">
    <p class="benefit">
      <strong>Understand why outdoor range hoods underperform</strong> &mdash;
      Click Research for papers covering BBQ plume physics, wind effects, BBQ hood geometry, and the failure modes manufacturers don't talk about.
    </p>
    <p class="benefit">
      <strong>Size and diagnose your BBQ Hood setup for free</strong> &mdash;
      Interactive tools &amp; calculators for outdoor BBQ ventilation that have never existed before.
    </p>
  </div>
  <div class="hero-cta" style="display:flex;justify-content:center;gap:10px;flex-wrap:nowrap;margin-top:24px;">
    <a href="/research/" class="cta-btn cta-primary">Browse Research</a>
    <a href="/tools/" class="cta-btn cta-secondary" style="text-align:center;line-height:1.3;">BBQ CFM Calculator<br><span style="font-size:0.7em;font-weight:400;opacity:0.75;">&amp; other tools</span></a>
  </div>
</section>

<!-- ===== QUESTION PICKER ===== -->
<section class="home-questions">
  <h2>What do you want to know?</h2>
  <div class="search-modes">
    <button class="search-mode-btn active" id="home-mode-topics">Browse Topics</button>
    <button class="search-mode-btn" id="home-mode-ai">AI Search</button>
  </div>
  <div id="home-topics-view">
    <div class="q-chips">
      <button class="q-chip" data-id="cfm">How many CFM does my outdoor hood need?</button>
      <button class="q-chip" data-id="indoor-outdoor">Can I use an indoor range hood outside?</button>
      <button class="q-chip" data-id="not-working">Why doesn't my outdoor range hood work?</button>
      <button class="q-chip" data-id="wind">Does wind affect my outdoor range hood?</button>
      <button class="q-chip" data-id="height">How high should I mount my outdoor range hood?</button>
    </div>
  </div>
  <div class="q-input-wrap">
    <input type="text" class="q-input" id="q-input" placeholder="Or type your own question...">
    <input type="text" name="website" class="q-honey" autocomplete="off" tabindex="-1" aria-hidden="true">
    <button class="q-submit">Ask</button>
  </div>
  <div class="q-answer" id="q-answer">
    <p class="q-answer-text" id="q-answer-text"></p>
    <p class="q-answer-label">Related topics:</p>
    <div class="q-answer-links"></div>
    <p class="q-answer-source" id="q-answer-source"></p>
    <button class="q-ask-another" id="q-ask-another">Ask another question</button>
  </div>
  <div class="q-history" id="q-history" style="display:none;">
    <div class="q-history-label">Recent questions</div>
    <div class="q-history-list" id="q-history-list"></div>
  </div>
  <div id="turnstile-container" class="cf-turnstile" data-sitekey="0x4AAAAAACcaq_joFScewE6d" data-size="invisible"></div>
</section>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" defer></script>
<script>
(function() {
  var chips = document.querySelectorAll('.q-chip');
  var answerEl = document.getElementById('q-answer');
  var answerText = document.getElementById('q-answer-text');
  var historyEl = document.getElementById('q-history');
  var historyList = document.getElementById('q-history-list');
  var askAnotherBtn = document.getElementById('q-ask-another');

  // Mode toggle
  var modeTopics = document.getElementById('home-mode-topics');
  var modeAi = document.getElementById('home-mode-ai');
  var topicsView = document.getElementById('home-topics-view');
  var qInput = document.getElementById('q-input');

  modeTopics.addEventListener('click', function() {
    modeTopics.classList.add('active');
    modeAi.classList.remove('active');
    topicsView.style.display = '';
    qInput.placeholder = 'Or type your own question...';
  });
  modeAi.addEventListener('click', function() {
    modeAi.classList.add('active');
    modeTopics.classList.remove('active');
    topicsView.style.display = 'none';
    qInput.placeholder = 'Ask a question about outdoor cooking ventilation...';
    qInput.focus();
  });

  // Turnstile: render widget after API loads
  var turnstileToken = null;
  var turnstileWidgetId = null;
  function initTurnstile() {
    if (typeof turnstile !== 'undefined' && !turnstileWidgetId) {
      turnstileWidgetId = turnstile.render('#turnstile-container', {
        sitekey: '0x4AAAAAACcaq_joFScewE6d',
        size: 'invisible',
        callback: function(token) { turnstileToken = token; }
      });
    }
  }
  // Try immediately and also on load
  if (document.readyState === 'complete') {
    setTimeout(initTurnstile, 100);
  } else {
    window.addEventListener('load', function() { setTimeout(initTurnstile, 100); });
  }

  // Question history (localStorage, last 5)
  var HISTORY_KEY = 'ovs_question_history';
  function getHistory() {
    try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; }
    catch (e) { return []; }
  }
  function addToHistory(text) {
    var h = getHistory();
    // Remove duplicate if exists
    h = h.filter(function(q) { return q !== text; });
    h.unshift(text);
    if (h.length > 5) h = h.slice(0, 5);
    try { localStorage.setItem(HISTORY_KEY, JSON.stringify(h)); } catch (e) {}
    renderHistory();
  }
  function renderHistory() {
    var h = getHistory();
    if (h.length === 0) { historyEl.style.display = 'none'; return; }
    historyEl.style.display = '';
    var html = '';
    for (var i = 0; i < h.length; i++) {
      html += '<button class="q-history-item" title="' + h[i].replace(/"/g, '&quot;') + '">' + h[i] + '</button>';
    }
    historyList.innerHTML = html;
    // Attach click handlers
    var items = historyList.querySelectorAll('.q-history-item');
    items.forEach(function(item) {
      item.addEventListener('click', function() {
        input.value = item.title;
        handleCustom();
      });
    });
  }
  renderHistory();

  // "Ask another question" button
  askAnotherBtn.addEventListener('click', function() {
    input.value = '';
    input.focus();
    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });

  function revealAnswer() {
    answerEl.classList.remove('visible');
    void answerEl.offsetHeight;
    answerEl.classList.add('visible');
    answerEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function buildLinks(links) {
    var linksEl = answerEl.querySelector('.q-answer-links');
    var html = '';
    for (var i = 0; i < links.length; i++) {
      html += '<a href="' + links[i].url + '">' + links[i].label + ' \u2192</a>';
    }
    linksEl.innerHTML = html;
  }

  function showAnswer(id) {
    var topic = topicAnswers[id];
    if (!topic) return;
    answerText.textContent = topic.answer;
    buildLinks(topic.links);
    var sourceEl = document.getElementById('q-answer-source');
    if (sourceEl) sourceEl.textContent = '';
    revealAnswer();
    fetch('/api/track', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question_id: id })
    }).catch(function() {});
  }

  chips.forEach(function(chip) {
    chip.addEventListener('click', function() {
      chips.forEach(function(c) { c.classList.remove('active'); });
      chip.classList.add('active');
      showAnswer(chip.getAttribute('data-id'));
    });
  });

  // All topic answers — unified map for keywords + extra topics
  // Links use #anchor fragments to jump to the specific section
  var topicAnswers = {
    'cfm': {
      answer: 'Outdoor installations need 1.7\u20132.5x the CFM of indoor specs. Use the physics-based calculator with your specific grill type, mounting height, and wind exposure.',
      links: [
        { url: '/tools/cfm-calculator/', label: 'CFM Calculator' },
        { url: '/research/rb-008-cfm-requirements/#311-quick-reference-cfm-table-at-30-inch-mounting-height', label: 'Quick-Reference CFM Table' },
        { url: '/research/rb-008-cfm-requirements/#35-outdoor-correction-factors-relative-to-indoor-baselines', label: 'Outdoor vs Indoor CFM Correction Factors' }
      ]
    },
    'indoor-outdoor': {
      answer: 'Indoor specs undersize outdoor installations by 40\u201360% because they assume wall confinement and pressure-assisted capture that don\u2019t exist outdoors.',
      links: [
        { url: '/tools/indoor-vs-outdoor-comparison/', label: 'Indoor vs Outdoor Comparison Tool' },
        { url: '/research/rb-004-indoor-vs-outdoor-assumptions/#21-the-six-indoor-capture-advantages', label: 'The Six Indoor Capture Advantages' },
        { url: '/research/rb-004-indoor-vs-outdoor-assumptions/#39-indoor-versus-outdoor-comparison-table-reference-case', label: 'Indoor vs Outdoor Comparison Table' }
      ]
    },
    'not-working': {
      answer: 'Six common failure modes: wind deflection, mounted too high, hood too small, insufficient CFM, wrong position, and duct restriction.',
      links: [
        { url: '/tools/failure-mode-taxonomy/', label: 'Failure Mode Diagram' },
        { url: '/research/rb-007-failure-modes/#31-failure-mode-taxonomy-overview', label: 'Failure Mode Taxonomy Overview' },
        { url: '/research/rb-007-failure-modes/#310-diagnostic-decision-tree', label: 'Diagnostic Decision Tree' },
        { url: '/research/rb-007-failure-modes/#311-corrective-action-matrix', label: 'Corrective Action Matrix' }
      ]
    },
    'wind': {
      answer: 'Wind is the #1 factor. At 5\u20137 mph crosswind, the plume begins leaving the capture zone. Side panels are more effective than increasing blower power.',
      links: [
        { url: '/tools/wind-deflection-trajectory/', label: 'Wind Deflection Tool' },
        { url: '/research/rb-006-wind-interaction-crossflow/#34-critical-wind-speed-analysis', label: 'Critical Wind Speed Analysis' },
        { url: '/research/rb-006-wind-interaction-crossflow/#32-plume-deflection-tables-comprehensive-results', label: 'Plume Deflection Tables' },
        { url: '/research/rb-009-side-panel-effectiveness/#31-panel-wind-reduction-comprehensive-results', label: 'Side Panel Wind Reduction Results' }
      ]
    },
    'height': {
      answer: 'As low as safely possible \u2014 24\u201330 inches. CFM requirements scale with height to the 5/3 power: doubling the height roughly triples the airflow needed.',
      links: [
        { url: '/tools/velocity-decay-curves/', label: 'Velocity Decay Curves Tool' },
        { url: '/research/rb-003-velocity-decay-capture/#37-critical-mounting-height-analysis', label: 'Critical Mounting Height Analysis' },
        { url: '/research/rb-003-velocity-decay-capture/#38-cfm-versus-mounting-height-engineering-lookup-tables', label: 'CFM vs Mounting Height Tables' }
      ]
    },
    'grease': {
      answer: 'Grease aerosols from missed plume travel 3\u201330+ feet depending on particle size. Coarse droplets land near the grill; ultrafine particles travel much farther.',
      links: [
        { url: '/tools/grease-aerosol-deposition/', label: 'Grease Deposition Tool' },
        { url: '/research/rb-011-grease-aerosol-transport/#33-particle-size-dependent-transport-distances', label: 'Particle Size Transport Distances' },
        { url: '/research/rb-011-grease-aerosol-transport/#34-deposition-pattern-characterization', label: 'Deposition Pattern Analysis' }
      ]
    },
    'side-panel': {
      answer: 'Side panels restore partial confinement, reducing required CFM by ~28% and improving capture efficiency by 25\u201335 percentage points.',
      links: [
        { url: '/tools/side-panel-effectiveness/', label: 'Side Panel Tool' },
        { url: '/research/rb-009-side-panel-effectiveness/#32-effective-capture-area-improvement-quantitative-results', label: 'Capture Area Improvement Results' },
        { url: '/research/rb-009-side-panel-effectiveness/#38-combined-panel-plus-cfm-optimization', label: 'Panel + CFM Optimization' }
      ]
    },
    'hood-size': {
      answer: 'The hood must extend beyond the cooking surface on all sides to capture the expanding plume. Indoor-spec hoods are typically 20\u201340% too narrow for outdoor use.',
      links: [
        { url: '/tools/hood-geometry-comparison/', label: 'Hood Geometry Tool' },
        { url: '/research/rb-005-hood-geometry-capture/#31-overhang-analysis-minimum-and-recommended-values', label: 'Overhang Analysis' },
        { url: '/research/rb-005-hood-geometry-capture/#38-design-guideline-tables--primary-engineering-deliverable', label: 'Hood Design Guideline Tables' }
      ]
    },
    'plume': {
      answer: 'Cooking plumes are buoyancy-driven \u2014 hot gases rise, entraining surrounding air and expanding as they climb. Width and velocity follow Heskestad correlations.',
      links: [
        { url: '/tools/velocity-decay-curves/', label: 'Plume Velocity Curves Tool' },
        { url: '/research/rb-001-buoyant-plume-behavior/#32-flame-height-and-virtual-origin-calculations', label: 'Flame Height & Virtual Origin' },
        { url: '/research/rb-002-entrainment-lateral-plume-spread/#34-plume-spread-analysis-quantitative-width-at-each-height', label: 'Plume Width at Each Height' }
      ]
    },
    'heat': {
      answer: 'Different fuel types produce dramatically different heat release rates. Wood-fired sources exceed 40 kW; pellet smokers produce under 5 kW. This directly determines plume strength and CFM.',
      links: [
        { url: '/tools/heat-release-rate-comparison/', label: 'Heat Release Comparison Tool' },
        { url: '/research/rb-001-buoyant-plume-behavior/#31-heat-release-rates-of-common-outdoor-cooking-appliances', label: 'Heat Release Rates by Appliance' }
      ]
    },
    'duct': {
      answer: 'Duct sizing, routing, and restriction directly affect exhaust performance. Long runs, excessive elbows, and undersized ducts reduce effective CFM at the hood.',
      links: [
        { url: '/research/rb-008-cfm-requirements/#310-hood-geometry-correction-effect-of-undersized-hoods-on-effective-cfm', label: 'Effect of Restrictions on Effective CFM' },
        { url: '/research/rb-007-failure-modes/#34-fm-3-insufficient-exhaust-rate', label: 'Failure Mode: Insufficient Exhaust Rate' },
        { url: '/tools/cfm-calculator/', label: 'CFM Calculator' }
      ]
    },
    'standards': {
      answer: 'No existing standard \u2014 ASHRAE 154, IMC, or UL 710 \u2014 provides comprehensive guidance for outdoor hood systems. This research identifies the specific gaps.',
      links: [
        { url: '/research/rb-010-standards-gaps/#31-standards-gaps', label: 'Standards Gaps Analysis' },
        { url: '/research/rb-010-standards-gaps/#32-code-gaps', label: 'Building Code Gaps' },
        { url: '/research/rb-004-indoor-vs-outdoor-assumptions/#21-the-six-indoor-capture-advantages', label: 'Why Indoor Assumptions Fail Outdoors' }
      ]
    },
    'radiation': {
      answer: 'Thermal radiation from high-heat sources (wood-fired, charcoal) affects hood surface temperatures and material selection. Radiation intensity follows inverse-square decay.',
      links: [
        { url: '/research/rb-012-thermal-radiation-hood-surfaces/#31-radiant-heat-flux-at-the-hood-surface', label: 'Radiant Heat Flux at Hood Surface' },
        { url: '/research/rb-012-thermal-radiation-hood-surfaces/#32-hood-surface-equilibrium-temperature', label: 'Hood Surface Temperature Analysis' },
        { url: '/research/rb-012-thermal-radiation-hood-surfaces/#34-material-temperature-rating-requirements', label: 'Material Temperature Ratings' }
      ]
    }
  };

  // Keyword-to-topic mapping
  var keywordMap = [
    { keywords: ['cfm', 'airflow', 'how much air', 'how many cfm', 'blower size', 'exhaust rate', 'cubic feet', 'ventilation rate', 'fan size', 'suction'], id: 'cfm' },
    { keywords: ['indoor', 'inside hood', 'indoor hood outside', 'indoor range hood', 'repurpose', 'bring outside', 'use indoors'], id: 'indoor-outdoor' },
    { keywords: ['not working', 'doesn\'t work', 'doesnt work', 'broken', 'fail', 'smoke escape', 'smoke coming', 'not catching', 'not capturing', 'problem with'], id: 'not-working' },
    { keywords: ['wind', 'breeze', 'crosswind', 'gust', 'windy', 'draft'], id: 'wind' },
    { keywords: ['height', 'how high', 'mount', 'how far above', 'install height', 'above grill', 'clearance', 'inches above'], id: 'height' },
    { keywords: ['grease', 'oil', 'fat', 'drip', 'splatter', 'aerosol', 'residue', 'buildup'], id: 'grease' },
    { keywords: ['side panel', 'baffle', 'shield', 'wind guard', 'wind block'], id: 'side-panel' },
    { keywords: ['hood size', 'geometry', 'overhang', 'too small', 'too narrow', 'dimensions'], id: 'hood-size' },
    { keywords: ['plume', 'smoke rise', 'thermal plume', 'buoyant', 'entrainment'], id: 'plume' },
    { keywords: ['btu', 'heat release', 'fuel type', 'wood fire', 'charcoal vs', 'pellet vs', 'gas grill vs'], id: 'heat' },
    { keywords: ['duct', 'ductwork', 'duct run', 'duct size', 'duct restriction'], id: 'duct' },
    { keywords: ['standard', 'code', 'ashrae', 'ul 710', 'imc', 'regulation'], id: 'standards' },
    { keywords: ['radiation', 'radiant heat', 'surface temperature'], id: 'radiation' }
  ];

  function matchKeywords(text) {
    var lower = text.toLowerCase();
    for (var i = 0; i < keywordMap.length; i++) {
      for (var j = 0; j < keywordMap[i].keywords.length; j++) {
        if (lower.indexOf(keywordMap[i].keywords[j]) !== -1) {
          return keywordMap[i].id;
        }
      }
    }
    return null;
  }

  // Full-text search (Fuse.js loaded on demand)
  var fuse = null;

  function loadSearchIndex(callback) {
    if (fuse) return callback();
    var script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js';
    script.onload = function() {
      fetch('/index.json').then(function(r) { return r.json(); }).then(function(data) {
        fuse = new Fuse(data, {
          keys: [
            { name: 'title', weight: 0.4 },
            { name: 'description', weight: 0.35 },
            { name: 'content', weight: 0.25 }
          ],
          threshold: 0.5,
          includeScore: true
        });
        callback();
      }).catch(function() { callback(); });
    };
    document.head.appendChild(script);
  }

  function showTopicAnswer(topicId, searchText) {
    var topic = topicAnswers[topicId];
    if (!topic) return;
    answerText.textContent = topic.answer;

    // Build primary links
    var links = topic.links.slice();

    // Also search for additional related pages
    if (fuse && searchText) {
      var results = fuse.search(searchText).slice(0, 5);
      var seen = {};
      for (var i = 0; i < links.length; i++) seen[links[i].url] = true;
      for (var i = 0; i < results.length; i++) {
        if (!seen[results[i].item.url] && links.length < 5) {
          links.push({ url: results[i].item.url, label: results[i].item.title });
          seen[results[i].item.url] = true;
        }
      }
    }

    buildLinks(links);
    revealAnswer();
  }

  function showSearchOnly(results) {
    if (!results || results.length === 0) {
      answerText.textContent = 'We couldn\u2019t find an exact match. Try different keywords, or explore:';
      buildLinks([
        { url: '/research/', label: 'Browse all research' },
        { url: '/tools/', label: 'Explore tools' }
      ]);
    } else {
      answerText.textContent = 'Here\u2019s what we found in our research:';
      var links = [];
      var top = results.slice(0, 5);
      for (var i = 0; i < top.length; i++) {
        links.push({ url: top[i].item.url, label: top[i].item.title });
      }
      buildLinks(links);
    }
    revealAnswer();
  }

  // Fallback to existing keyword + Fuse.js search
  function fallbackSearch(text) {
    var sourceEl = document.getElementById('q-answer-source');
    if (sourceEl) sourceEl.textContent = '';
    var topicId = matchKeywords(text);
    loadSearchIndex(function() {
      if (topicId) {
        showTopicAnswer(topicId, text);
      } else if (fuse) {
        showSearchOnly(fuse.search(text));
      } else {
        answerText.textContent = 'Browse our research papers and interactive tools to find your answer:';
        answerEl.querySelector('.q-answer-label').style.display = '';
        buildLinks([
          { url: '/research/', label: 'Browse all research' },
          { url: '/tools/', label: 'Explore tools' }
        ]);
        revealAnswer();
      }
      submit.disabled = false;
    });
  }

  // Custom question submit — tries AI first, falls back to Fuse.js
  var input = qInput;
  var submit = document.querySelector('.q-submit');
  function handleCustom() {
    var text = input.value.trim();
    if (!text) return;
    chips.forEach(function(c) { c.classList.remove('active'); });

    // Save to history
    addToHistory(text);

    var sourceEl = document.getElementById('q-answer-source');
    var labelEl = answerEl.querySelector('.q-answer-label');

    // Show loading state
    answerText.innerHTML = '<span class="q-answer-loading"><span class="spinner"></span> Searching research...</span>';
    answerEl.querySelector('.q-answer-links').innerHTML = '';
    labelEl.style.display = 'none';
    if (sourceEl) sourceEl.textContent = '';
    revealAnswer();
    submit.disabled = true;

    // Get honeypot and Turnstile token
    var honey = document.querySelector('.q-honey');
    var honeyVal = honey ? honey.value : '';
    var token = turnstileToken || '';

    // Try AI first
    fetch('/api/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question: text, cf_token: token, website: honeyVal })
    })
    .then(function(r) {
      if (!r.ok) throw new Error('ai_failed');
      return r.json();
    })
    .then(function(data) {
      if (data.error) throw new Error(data.error);
      // AI succeeded
      answerText.textContent = data.answer;
      labelEl.style.display = '';
      buildLinks(data.links || []);
      if (sourceEl) sourceEl.textContent = 'Answered by AI from site research';
      revealAnswer();
      submit.disabled = false;
    })
    .catch(function() {
      // AI failed — silent fallback to keyword + Fuse.js
      fallbackSearch(text);
    })
    .finally(function() {
      // Reset Turnstile for next question
      if (typeof turnstile !== 'undefined' && turnstileWidgetId) {
        turnstileToken = null;
        turnstile.reset(turnstileWidgetId);
      }
    });

    // Track custom questions (fire-and-forget)
    fetch('/api/track', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question_id: 'custom', text: text })
    }).catch(function() {});
  }
  submit.addEventListener('click', handleCustom);
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') handleCustom();
  });
})();
</script>

<!-- ===== MISSION ===== -->
<section class="home-mission">
  <h2>Why This Exists</h2>
  <p>
    Outdoor cooking ventilation operates under fundamentally different physical conditions than indoor kitchen ventilation,
    yet is routinely designed using indoor-derived assumptions. No existing standard &mdash; ASHRAE 154, the International
    Mechanical Code, or UL 710 &mdash; provides comprehensive, physics-based guidance for outdoor hood systems exposed to
    open boundaries, wind, and unconstrained plume dispersion.
  </p>
  <p>
    This program addresses that gap through applied physics research grounded in established principles:
  </p>
  <ul class="approach-list">
    <li><strong>Fire science</strong> &mdash; Heskestad plume correlations</li>
    <li><strong>Fluid dynamics</strong> &mdash; Morton-Taylor-Turner entrainment theory</li>
    <li><strong>Atmospheric dispersion</strong> &mdash; Briggs plume rise equations</li>
    <li><strong>Ventilation engineering</strong> &mdash; ASHRAE &amp; ACGIH analysis</li>
  </ul>
  <p>
    No marketing language. No product recommendations. No ungrounded claims. Every conclusion is traceable
    to a stated physical mechanism with explicit assumptions and applicable ranges.
  </p>
</section>

<!-- ===== DIAGRAM ===== -->
<section class="home-diagram">
  <img src="/diagrams/indoor-vs-outdoor-comparison.svg"
       alt="Diagram comparing indoor ventilation with wall confinement and pressure-assisted capture versus outdoor ventilation with open boundaries, wind deflection, and plume escape">
  <div class="diagram-caption">
    <strong>Why indoor ventilation assumptions fail outdoors.</strong>
    Indoor hoods benefit from wall confinement, ceiling redirection, and pressure-assisted capture &mdash;
    none of which exist in open-air environments.
    <a href="/tools/indoor-vs-outdoor-comparison/">View full analysis &rarr;</a>
  </div>
</section>

<!-- ===== FEATURE CARDS ===== -->
<div class="home-features">
  <a href="/research/" class="feature-card">
    <div class="card-icon">&#x1F4D1;</div>
    <h3>Research Library</h3>
    <p>
      12 peer-structured papers covering buoyant plume physics, entrainment, velocity decay,
      hood geometry, wind interaction, failure modes, CFM sizing, and standards gap analysis.
    </p>
    <span class="card-link">Browse all papers &rarr;</span>
  </a>
  <a href="/tools/" class="feature-card">
    <div class="card-icon">&#x1F527;</div>
    <h3>Interactive Tools</h3>
    <p>
      CFM sizing calculator, velocity decay curves, and comparison diagrams &mdash;
      all built on the physics from our research papers with full calculation transparency.
    </p>
    <span class="card-link">Explore tools &rarr;</span>
  </a>
  <a href="/governance/" class="feature-card">
    <div class="card-icon">&#x1F3DB;</div>
    <h3>Governance</h3>
    <p>
      Research charter, controlled glossary, diagram standard, and agent role definitions.
      Every output is produced under formal quality governance.
    </p>
    <span class="card-link">View governance &rarr;</span>
  </a>
</div>

<!-- ===== RESEARCH HIGHLIGHTS ===== -->
<section class="home-section">
  <h2>Research Papers</h2>
  <div class="research-grid">
    <a href="/research/rb-001-buoyant-plume-behavior/" class="research-item">
      <span class="ri-id">RB-001</span>
      <div>
        <div class="ri-title">Buoyant Plume Behavior from Barbecue and High-Heat Cooking Sources</div>
        <div class="ri-tier">P0 &mdash; Foundation</div>
      </div>
    </a>
    <a href="/research/rb-002-entrainment-lateral-plume-spread/" class="research-item">
      <span class="ri-id">RB-002</span>
      <div>
        <div class="ri-title">Entrainment and Lateral Plume Spread in Open-Air Environments</div>
        <div class="ri-tier">P0 &mdash; Foundation</div>
      </div>
    </a>
    <a href="/research/rb-003-velocity-decay-capture/" class="research-item">
      <span class="ri-id">RB-003</span>
      <div>
        <div class="ri-title">Velocity Decay and Near-Field vs. Far-Field Capture</div>
        <div class="ri-tier">P0 &mdash; Foundation</div>
      </div>
    </a>
    <a href="/research/rb-004-indoor-vs-outdoor-assumptions/" class="research-item">
      <span class="ri-id">RB-004</span>
      <div>
        <div class="ri-title">Why Indoor Ventilation Assumptions Fail Outdoors</div>
        <div class="ri-tier">P1 &mdash; Core</div>
      </div>
    </a>
    <a href="/research/rb-005-hood-geometry-capture/" class="research-item">
      <span class="ri-id">RB-005</span>
      <div>
        <div class="ri-title">Impact of Hood Geometry on Capture Performance</div>
        <div class="ri-tier">P1 &mdash; Core</div>
      </div>
    </a>
    <a href="/research/rb-006-wind-interaction-crossflow/" class="research-item">
      <span class="ri-id">RB-006</span>
      <div>
        <div class="ri-title">Wind Interaction and Cross-Flow Effects</div>
        <div class="ri-tier">P1 &mdash; Core</div>
      </div>
    </a>
    <a href="/research/rb-007-failure-modes/" class="research-item">
      <span class="ri-id">RB-007</span>
      <div>
        <div class="ri-title">Failure Modes of Outdoor BBQ Hoods</div>
        <div class="ri-tier">P2 &mdash; Applied</div>
      </div>
    </a>
    <a href="/research/rb-008-cfm-requirements/" class="research-item">
      <span class="ri-id">RB-008</span>
      <div>
        <div class="ri-title">CFM Requirements for Outdoor Cooking Ventilation</div>
        <div class="ri-tier">P2 &mdash; Applied</div>
      </div>
    </a>
    <a href="/research/rb-009-side-panel-effectiveness/" class="research-item">
      <span class="ri-id">RB-009</span>
      <div>
        <div class="ri-title">Side Panel and Wind Baffle Effectiveness</div>
        <div class="ri-tier">P2 &mdash; Applied</div>
      </div>
    </a>
    <a href="/research/rb-010-standards-gaps/" class="research-item">
      <span class="ri-id">RB-010</span>
      <div>
        <div class="ri-title">Gaps in Existing Standards, Codes, and Consumer Guidance</div>
        <div class="ri-tier">P3 &mdash; Frontier</div>
      </div>
    </a>
    <a href="/research/rb-011-grease-aerosol-transport/" class="research-item">
      <span class="ri-id">RB-011</span>
      <div>
        <div class="ri-title">Grease Aerosol Transport and Deposition in Open Environments</div>
        <div class="ri-tier">P3 &mdash; Frontier</div>
      </div>
    </a>
    <a href="/research/rb-012-thermal-radiation-hood-surfaces/" class="research-item">
      <span class="ri-id">RB-012</span>
      <div>
        <div class="ri-title">Thermal Radiation and Plume Interaction at Hood Surfaces</div>
        <div class="ri-tier">P3 &mdash; Frontier</div>
      </div>
    </a>
  </div>
</section>

<!-- ===== SECOND DIAGRAM ===== -->
<section class="home-diagram">
  <img src="/diagrams/velocity-decay-curves.svg"
       alt="Chart showing centerline velocity decay curves for wood-fired, gas grill, charcoal, and pellet smoker plumes from 18 to 48 inch mounting heights">
  <div class="diagram-caption">
    <strong>Centerline velocity decay by source type.</strong>
    All sources maintain capture-viable velocities (&gt;0.8 m/s) at standard mounting heights,
    but plume width expansion &mdash; not velocity &mdash; is the primary capture constraint.
    <a href="/tools/velocity-decay-curves/">View full analysis &rarr;</a>
  </div>
</section>

<!-- ===== CTA ===== -->
<section class="home-cta">
  <p>Explore the research, use the tools, or review the methodology behind every finding.</p>
  <div class="cta-buttons">
    <a href="/research/" class="cta-btn cta-primary">Browse Research</a>
    <a href="/tools/" class="cta-btn cta-secondary">BBQ Tools</a>
    <a href="/methodology/" class="cta-btn cta-secondary">Methodology</a>
  </div>
</section>

{{- end }}
